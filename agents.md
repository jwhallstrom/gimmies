# agents.md

Operational guide for building, running, and deploying the Gimmies Golf app. Optimized for humans *and* automation agents so they reuse existing processes instead of spawning duplicate dev/build tasks.

---
## 1. Purpose
Central place to:
- Reuse the existing VS Code tasks (Dev Server, Build (prod))
- Avoid starting multiple dev servers / builds
- Standardize production build + AWS S3 deployment
- Handle caching + PWA/service worker updates safely
- Provide copy‑paste commands for Windows PowerShell + CI

---
## 2. Key Build Concepts
| Mode | Command Path | When to Use | Notes |
|------|--------------|-------------|-------|
| Dev  | `npm run dev -- --host` | Local iteration | Uses Vite dev server, auto reload |
| Prod Build | `npm run build` | Before deploy / verifying prod bundle | Outputs to `dist/` |
| Preview (optional) | `npx vite preview` | Serve built assets locally | Not wired as a task yet |

Tasks already defined (see `.vscode/tasks.json` auto-generated by VS Code):
- **Dev Server**: background task for `npm run dev -- --host`
- **Build (prod)**: runs the production build
- **Build + Dev (manual test)**: sequential build, then starts dev (mainly for sanity after a clean build)

> Agents / scripts SHOULD check for an existing terminal/task labeled `Dev Server` before starting another. Duplicate dev servers waste ports + memory.

---
## 3. Reusing Existing Tasks (Agent Behavior Recommendations)
1. Enumerate current terminals; if one contains `npm run dev` and is still active, reuse it.
2. Only trigger **Build (prod)** if:
   - A deployment is requested OR
   - Source files changed since last build (optional heuristic: compare `dist/` timestamps)
3. Never run `npm run build` concurrently with another build.
4. After build finishes, deploy from the same artifact directory (`dist/`). Do NOT rebuild just to deploy.

Pseudo-logic:
```pseudo
if taskExists('Dev Server') and taskIsRunning: skip start
else: runTask('Dev Server')

if needDeploy:
  runTask('Build (prod)')  # wait for completion
  deployDist()
```

---
## 4. Production Build Steps (Manual)
```powershell
# From repo root
npm ci            # or npm install (ci preferred in CI environments)
npm run build     # emits dist/
```
Output artifacts of interest:
- `dist/index.html`
- Hashed JS/CSS under `dist/assets/`
- PWA files: `sw.js`, `workbox-*.js`, `manifest.webmanifest`

### 4.1 Amplify Hosting (Auto‑deploy via GitHub)
If this repo is connected to AWS Amplify Hosting, a push to the tracked branch (e.g., `master`) automatically builds and deploys the app using the pipeline defined in `amplify.yml`.

- Where it’s documented: see `AMPLIFY_HOSTING_SETUP.md` for the production URL, App ID, and CI/CD overview
- Build spec: `amplify.yml` (backend deploy via `npx ampx pipeline-deploy`, frontend build publishes `dist/`)
- How to deploy (CI/CD):
  - Commit your changes and push to the configured branch (e.g., `master`)
  - Amplify picks up the commit, runs the build, and deploys
  - Check build logs in the Amplify Console → Build history

Note: If Amplify Hosting is enabled, you typically do NOT need the S3 steps below; they’re provided for manual/static hosting scenarios.

---
## 5. AWS S3 Deployment (Static Hosting)
Assumptions:
- Bucket name: `gimmies-golf` (static website hosting enabled)
- Index + Error documents both set to `index.html` (for SPA routing)
- AWS CLI v2 installed + configured (`aws configure` used previously)

### 5.1 Recommended Caching Strategy
Because Vite outputs hashed filenames, we can cache-bust automatically for JS/CSS. HTML must remain short‑lived so new builds propagate quickly.

Two-phase deployment (safe):
```powershell
# 1. Sync all non-HTML assets w/ long cache
aws s3 sync dist s3://gimmies-golf --delete `
  --exclude index.html `
  --cache-control "public,max-age=31536000,immutable"

# 2. Upload HTML (short cache)
aws s3 cp dist/index.html s3://gimmies-golf/index.html `
  --cache-control "public,max-age=60" `
  --content-type "text/html; charset=utf-8"
```
Optional: also apply short cache to `manifest.webmanifest` & `sw.js` so updates detected quickly:
```powershell
aws s3 cp dist/manifest.webmanifest s3://gimmies-golf/manifest.webmanifest `
  --cache-control "public,max-age=300" --content-type application/manifest+json
aws s3 cp dist/sw.js s3://gimmies-golf/sw.js `
  --cache-control "public,max-age=300" --content-type application/javascript
```

### 5.2 Single-Command (Fast but Less Granular)
```powershell
aws s3 sync dist s3://gimmies-golf --delete --cache-control "public,max-age=300"
```
Use only for early staging; all files get the same short cache.

### 5.3 Optional CloudFront
If fronted by CloudFront:
```powershell
aws cloudfront create-invalidation --distribution-id YOUR_DIST_ID --paths /index.html /manifest.webmanifest /sw.js
```
Invalidate only the few short‑cache assets.

---
## 6. Add a Deploy Script (Optional Enhancement)
Add to `package.json` (not yet added automatically):
```jsonc
"scripts": {
  // ...existing scripts
  "deploy": "npm run build && aws s3 sync dist s3://gimmies-golf --delete --exclude index.html --cache-control public,max-age=31536000,immutable && aws s3 cp dist/index.html s3://gimmies-golf/index.html --cache-control public,max-age=60 --content-type text/html"
}
```
Then:
```powershell
npm run deploy
```
Agents: prefer calling the existing **Build (prod)** task first, then running only the `aws` commands to avoid double builds.

---
## 7. PWA / Service Worker Notes
- Build generates `sw.js` each time; users may see prior cached version until next navigation.
- Keeping `sw.js` on a short cache (≤5 min) accelerates adoption of new releases.
- If critical hotfix: bump a dummy query param in `index.html` referencing the register script OR manually invalidate.
- To force immediate activation in future: add logic in service worker registration to call `skipWaiting()` + `clients.claim()` after update (not yet implemented here).

---
## 8. Safe Agent Behaviors Summary
| Action | MUST | MUST NOT |
|--------|------|----------|
| Start dev | Check if running first | Spawn duplicates |
| Build | Run once per deploy | Rebuild after a fresh build before deploy |
| Deploy | Use existing `dist/` | Upload partial / stale artifacts |
| Cache | Long-cache hashed assets | Long-cache `index.html` |
| SW | Short cache or invalidate | Assume users see new code instantly |

---
## 9. Troubleshooting
| Symptom | Cause | Fix |
|---------|-------|-----|
| New UI not visible | Browser using old SW cache | Hard refresh (Ctrl+F5) or wait cache TTL; confirm `sw.js` short cache |
| 404 on deep link | Bucket missing website routing OR wrong error doc | Set index & error document to `index.html` |
| Layout different in prod | Tailwind purge misconfig | Ensure classes are static strings or safelisted |
| Double dev ports | Multiple dev tasks started | Reuse existing terminal labeled Dev Server |

---
## 10. CI/CD Sketch (Optional)
```yaml
steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-node@v4
    with: { node-version: 20 }
  - run: npm ci
  - run: npm run build
  - run: aws s3 sync dist s3://gimmies-golf --delete --exclude index.html --cache-control "public,max-age=31536000,immutable"
  - run: aws s3 cp dist/index.html s3://gimmies-golf/index.html --cache-control "public,max-age=60" --content-type text/html
```

---
## 11. Future Improvements
- Add `deploy` script (if approved) to `package.json`
- Add a `preview` VS Code task for `npx vite preview`
- Automate CloudFront invalidation (if distribution added)
- Service worker update toast ("New version available – Refresh?")

---
## 12. Quick Reference (Copy-Paste)
```powershell
# Build
npm run build

# Deploy (2-phase recommended)
aws s3 sync dist s3://gimmies-golf --delete --exclude index.html --cache-control "public,max-age=31536000,immutable"
aws s3 cp dist/index.html s3://gimmies-golf/index.html --cache-control "public,max-age=60" --content-type "text/html; charset=utf-8"
```

---
**End of agents.md**
